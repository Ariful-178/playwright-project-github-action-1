name: Playwright Test & Deploy Report

on:
  schedule:
    # 3 PM Bangladesh time = 09:00 UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # allows manual run

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.test-status.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        id: playwright-tests
        run: |
          npx playwright test --reporter=html || echo "::warning::Some tests failed"
          # Capture test exit status
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Check test results
        id: test-status
        run: |
          if [ "${{ steps.playwright-tests.outputs.exit_code }}" -eq "0" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "All tests passed!"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Some tests failed. Continuing with deployment of results..."
          fi

      - name: Prepare dated report folder
        run: |
          DATE=$(date +'%Y-%m-%d')
          mkdir -p public/$DATE
          cp -r playwright-report/* public/$DATE/
          
          # Generate index page with all reports
          echo "<!DOCTYPE html><html><head><title>Playwright Test Reports</title>" > public/index.html
          echo "<style>body{font-family: Arial, sans-serif; margin: 40px;}" >> public/index.html
          echo "h1{color: #333;} ul{list-style-type: none; padding: 0;}" >> public/index.html
          echo "li{margin: 10px 0;} a{text-decoration: none; color: #0366d6;}" >> public/index.html
          echo "a:hover{text-decoration: underline;}</style></head>" >> public/index.html
          echo "<body><h1>Playwright Test Reports</h1><ul>" >> public/index.html
          
          # Find all dated folders and list them
          for dir in $(find public -maxdepth 1 -type d -name "20*" | sort -r); do
            dirname=$(basename $dir)
            echo "<li><a href=\"$dirname/index.html\">$dirname</a></li>" >> public/index.html
          done
          echo "</ul></body></html>" >> public/index.html

      - name: Upload test report artifact
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            public/
            playwright-report/
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: always() # Always run deploy even if tests fail, but we'll know the status
    
    steps:
      - name: Download test report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: public

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Report deployment status
        run: |
          if [ "${{ needs.test.outputs.status }}" == "success" ]; then
            echo "✅ All tests passed and report deployed successfully!"
          else
            echo "❌ Some tests failed! Report deployed with failure details."
            # Exit with error code to mark workflow as failed
            exit 1
          fi
